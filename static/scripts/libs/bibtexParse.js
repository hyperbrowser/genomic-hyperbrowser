!function(a){function b(){this.months=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"],this.notKey=[",","{","}"," ","="],this.pos=0,this.input="",this.entries=new Array,this.currentEntry="",this.setInput=function(a){this.input=a},this.getEntries=function(){return this.entries},this.isWhitespace=function(a){return" "==a||"\r"==a||"	"==a||"\n"==a},this.match=function(a,b){if((void 0==b||null==b)&&(b=!0),this.skipWhitespace(b),this.input.substring(this.pos,this.pos+a.length)!=a)throw"Token mismatch, expected "+a+", found "+this.input.substring(this.pos);this.pos+=a.length,this.skipWhitespace(b)},this.tryMatch=function(a,b){return(void 0==b||null==b)&&(b=!0),this.skipWhitespace(b),this.input.substring(this.pos,this.pos+a.length)==a?!0:!1},this.matchAt=function(){for(;this.input.length>this.pos&&"@"!=this.input[this.pos];)this.pos++;return"@"==this.input[this.pos]?!0:!1},this.skipWhitespace=function(a){for(;this.isWhitespace(this.input[this.pos]);)this.pos++;if("%"==this.input[this.pos]&&1==a){for(;"\n"!=this.input[this.pos];)this.pos++;this.skipWhitespace(a)}},this.value_braces=function(){var a=0;this.match("{",!1);for(var b=this.pos,c=!1;;){if(!c)if("}"==this.input[this.pos]){if(!(a>0)){var d=this.pos;return this.match("}",!1),this.input.substring(b,d)}a--}else if("{"==this.input[this.pos])a++;else if(this.pos>=this.input.length-1)throw"Unterminated value";c="\\"==this.input[this.pos]&&0==c?!0:!1,this.pos++}},this.value_comment=function(){for(var a="",b=0;!this.tryMatch("}",!1)||0!=b;){if(a+=this.input[this.pos],"{"==this.input[this.pos]&&b++,"}"==this.input[this.pos]&&b--,this.pos>=this.input.length-1)throw"Unterminated value:"+this.input.substring(start);this.pos++}return a},this.value_quotes=function(){this.match('"',!1);for(var a=this.pos,b=!1;;){if(!b){if('"'==this.input[this.pos]){var c=this.pos;return this.match('"',!1),this.input.substring(a,c)}if(this.pos>=this.input.length-1)throw"Unterminated value:"+this.input.substring(a)}b="\\"==this.input[this.pos]&&0==b?!0:!1,this.pos++}},this.single_value=function(){var a=this.pos;if(this.tryMatch("{"))return this.value_braces();if(this.tryMatch('"'))return this.value_quotes();var b=this.key();if(b.match("^[0-9]+$"))return b;if(this.months.indexOf(b.toLowerCase())>=0)return b.toLowerCase();throw"Value expected:"+this.input.substring(a)+" for key: "+b},this.value=function(){var a=[];for(a.push(this.single_value());this.tryMatch("#");)this.match("#"),a.push(this.single_value());return a.join("")},this.key=function(a){for(var b=this.pos;;){if(this.pos>=this.input.length)throw"Runaway key";if(this.notKey.indexOf(this.input[this.pos])>=0)return a&&","!=this.input[this.pos]?(this.pos=b,null):this.input.substring(b,this.pos);this.pos++}},this.key_equals_value=function(){var a=this.key();if(this.tryMatch("=")){this.match("=");var b=this.value();return a=a.trim(),[a,b]}throw"... = value expected, equals sign missing:"+this.input.substring(this.pos)},this.key_value_list=function(){var a=this.key_equals_value();for(this.currentEntry.entryTags={},this.currentEntry.entryTags[a[0]]=a[1];this.tryMatch(",")&&(this.match(","),!this.tryMatch("}"));)a=this.key_equals_value(),this.currentEntry.entryTags[a[0]]=a[1]},this.entry_body=function(a){this.currentEntry={},this.currentEntry.citationKey=this.key(!0),this.currentEntry.entryType=a.substring(1),null!=this.currentEntry.citationKey&&this.match(","),this.key_value_list(),this.entries.push(this.currentEntry)},this.directive=function(){return this.match("@"),"@"+this.key()},this.preamble=function(){this.currentEntry={},this.currentEntry.entryType="PREAMBLE",this.currentEntry.entry=this.value_comment(),this.entries.push(this.currentEntry)},this.comment=function(){this.currentEntry={},this.currentEntry.entryType="COMMENT",this.currentEntry.entry=this.value_comment(),this.entries.push(this.currentEntry)},this.entry=function(a){this.entry_body(a)},this.alernativeCitationKey=function(){this.entries.forEach(function(a){!a.citationKey&&a.entryTags&&(a.citationKey="",a.entryTags.author&&(a.citationKey+=a.entryTags.author.split(",")[0]+=", "),a.citationKey+=a.entryTags.year)})},this.bibtex=function(){for(;this.matchAt();){var a=this.directive();this.match("{"),"@STRING"==a.toUpperCase()?this.string():"@PREAMBLE"==a.toUpperCase()?this.preamble():"@COMMENT"==a.toUpperCase()?this.comment():this.entry(a),this.match("}")}this.alernativeCitationKey()}}a.toJSON=function(a){var c=new b;return c.setInput(a),c.bibtex(),c.entries},a.toBibtex=function(a){var b="";for(var c in a){if(b+="@"+a[c].entryType,b+="{",a[c].citationKey&&(b+=a[c].citationKey+", "),a[c].entry&&(b+=a[c].entry),a[c].entryTags){var d="";for(var e in a[c].entryTags)0!=d.length&&(d+=", "),d+=e+"= {"+a[c].entryTags[e]+"}";b+=d}b+="}\n\n"}return b}}("undefined"==typeof exports?this.bibtexParse={}:exports);
//# sourceMappingURL=../../maps/libs/bibtexParse.js.map